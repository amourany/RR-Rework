package network;

import game.BoardPiece;
import game.Constant.Color;
import game.Robot;

import java.io.File;
import java.io.IOException;
import java.net.DatagramPacket;
import java.net.DatagramSocket;
import java.net.InetAddress;
import java.net.SocketException;
import java.util.ArrayList;
import java.util.List;

import launcher.Controller;

/**
 * Client side of the application
 */
public class Client{
	
	private InetAddress ipServer;
	private Controller controller;
	DatagramSocket socket;
	private List<String> waitingMsg;
	
	private Thread clientThread = new Thread() {
		public void run() {
			listen();
		}
	};
	
	public Client(InetAddress dest, Controller controller) {
		ipServer = dest;
		this.controller = controller;
		waitingMsg = new ArrayList<String>();
		
		try {
			socket = new DatagramSocket(3002);
		} catch (SocketException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		clientThread.start();
	}
	
	private void listen() {
		String data;
		byte[] buffer = new byte[15000];
		DatagramPacket packet = new DatagramPacket(buffer, buffer.length);
		
		while(true) {
			try {
				socket.receive(packet);
			} catch (IOException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
			
			data = new String(packet.getData(), 0, packet.getLength());
			waitingMsg.add(data);
			
			System.out.println("Received : " + data + " from : " + packet.getAddress());
			process(data);
			}
	}

	public void connect() {
		try {
			String g = "connect";
			byte[] bG = g.getBytes();
			DatagramPacket packet = new DatagramPacket(bG, bG.length, ipServer, 3001);
			packet.setData(bG);
			
			socket.send(packet);			
		} catch (SocketException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		} catch (IOException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
	}
	
	public void process(String data) {
		String[] splitData = new String[10];
		splitData = data.split("&");
		
		switch(splitData[0]) {
			case "board":
				int initialLocation = Integer.parseInt(splitData[1]);
				int finalLocation = Integer.parseInt(splitData[2]);
				controller.setBoard(new BoardPiece(new File(splitData[3]), initialLocation, finalLocation));
				break;
			case "robot":
				int x = Integer.parseInt(splitData[1]);
				int y = Integer.parseInt(splitData[2]);
				int originX = Integer.parseInt(splitData[4]);
				int originY = Integer.parseInt(splitData[5]);
				controller.setRobot(new Robot(x, y, Color.valueOf(splitData[3]), originX, originY));
				break;
			case "refresh":
				controller.refreshBoard();
				break;
			default:
				System.out.println("Flag inconnu");
				break;
		}
	}
}